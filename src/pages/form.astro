---
// Import af genbrugelige komponenter
import MainLayout from "../layouts/MainLayout.astro";
import Heading from "../components/Heading.astro";
import Text from "../components/Text.astro";
import Button from "../components/Button.astro";
---

<MainLayout title="Kontakt os">
  <!-- Hovedsektion med tilmeldingsformular -->
  <section
    class="px-(--margin-section_left) py-(--margin-section_top) bg-white"
  >
    <div class="max-w-4xl mx-auto">
      <Heading
        htmlheading="h1"
        size="large"
        weight="bold"
        font="display"
        stylingclasses="mb-6"
      >
        TILMELDING
      </Heading>

      <Text size="large" stylingclasses="mb-12 text-[var(--color-black)]">
        Tak fordi du vil støtte os. Inden vi kan tage i mod din hjælp skal du
        oplyse din email og hvilken form for støtte du vil give. Vi kontakter
        dig efterfølgende og bekræfter din tilmelding.
      </Text>

      <!-- Formular div-->
      <div class="max-w-2xl mx-auto p-8 bg-white shadow-lg rounded-contentBox">
        <!-- Alpine.js formular - x-data kobler til emailForm funktionen -->
        <!-- @submit.prevent forhindrer standard formular submit og kalder vores submit() funktion -->
        <form x-data="emailForm" @submit.prevent="submit" class="space-y-6">
          <!-- Dropdown: Vælg privatperson eller virksomhed -->
          <!-- x-model="type" binder værdien til Alpine's type variabel -->
          <div>
            <label class="block mb-1 font-semibold">
              Er du privatperson eller virksomhed?
            </label>
            <select
              x-model="type"
              class="form-select w-full rounded-contentBox border"
            >
              <option value="privat">Privatperson</option>
              <option value="firma">Firma</option>
            </select>
          </div>

          <!-- Privatperson felter - kun vist når type === 'privat' -->
          <!-- x-show styrer synlighed, x-transition tilføjer smooth animation -->
          <div x-show="type === 'privat'" x-transition class="space-y-4">
            <div>
              <label class="block mb-1 font-semibold">Fornavn</label>
              <input
                x-ref="firstName"
                type="text"
                class="form-input w-full rounded-contentBox border"
                placeholder="Fornavn"
              />
            </div>

            <div>
              <label class="block mb-1 font-semibold">Efternavn</label>
              <input
                x-ref="lastName"
                type="text"
                class="form-input w-full rounded-contentBox border"
                placeholder="Efternavn"
              />
            </div>
          </div>

          <!-- Firma felter - kun vist når type === 'firma' -->
          <div x-show="type === 'firma'" x-transition class="space-y-4">
            <div>
              <label class="block mb-1 font-semibold">Firmanavn</label>
              <input
                x-ref="companyName"
                type="text"
                class="form-input w-full rounded-contentBox border"
                placeholder="Firmanavn"
              />
            </div>

            <div>
              <label class="block mb-1 font-semibold">CVR-nummer</label>
              <input
                x-ref="cvr"
                type="text"
                class="form-input w-full rounded-contentBox border"
                placeholder="CVR-nummer"
              />
            </div>

            <div>
              <label class="block mb-1 font-semibold">Adresse</label>
              <input
                x-ref="companyAddress"
                type="text"
                class="form-input w-full rounded-contentBox border"
                placeholder="Adresse"
              />
            </div>
          </div>

          <!-- Email felt - obligatorisk -->
          <div>
            <label class="block mb-1 font-semibold">E-mail</label>
            <input
              x-ref="email"
              type="email"
              class="form-input w-full rounded-contentBox border"
              placeholder="eksempel@email.com"
            />
          </div>

          <!-- Telefonnummer felt med auto-sanitering -->
          <!-- @input fjerner ugyldige tegn mens brugeren skriver -->
          <div>
            <label class="block mb-1 font-semibold">Telefonnummer</label>
            <input
              x-ref="phone"
              type="tel"
              placeholder="+45 00 00 00 00"
              class="form-input w-full rounded-contentBox border"
              @input="$el.value = $el.value.replace(/[^0-9+ ]/g,'')"
            />
          </div>

          <!-- Støtteform dropdown - obligatorisk -->
          <div>
            <label class="block mb-1 font-semibold">Støtteform</label>
            <select
              x-ref="subject"
              class="form-select w-full rounded-contentBox border"
            >
              <option value="" disabled selected>Vælg en mulighed</option>
              <option value="Frivillig">Frivillig</option>
              <option value="Støttemedlem">Støttemedlem</option>
              <option value="Samarbejdspartner">Samarbejdspartner</option>
              <option value="Erhvervspartner">Erhvervspartner</option>
              <option value="Budskabet">Budskabet</option>
              <option value="andet">Andet</option>
            </select>
          </div>

          <!-- Besked felt - valgfrit -->
          <div>
            <label class="block mb-1 font-semibold">Besked</label>
            <textarea
              x-ref="message"
              rows="6"
              class="form-textarea w-full rounded-contentBox border"
              placeholder="Skriv din besked her…"></textarea>
          </div>

          <!-- Accept checkbox - obligatorisk -->
          <div class="flex items-center gap-2">
            <input
              id="accept"
              x-ref="accept"
              type="checkbox"
              class="form-checkbox"
            />
            <label for="accept">Jeg accepterer</label>
          </div>

          <!-- Fejlbesked - kun vist når der er en fejl -->
          <!-- x-show="error" viser kun hvis error ikke er tom -->
          <!-- x-text="error" indsætter fejlteksten -->
          <p x-show="error" x-text="error" class="text-red-600 font-semibold">
          </p>

          <!-- Submit knap -->
          <Button type="submit" variant="black" size="large">
            Send besked
          </Button>
        </form>
      </div>
    </div>
  </section>
</MainLayout>

<script is:inline>
  // Vent på Alpine er klar
  document.addEventListener("alpine:init", () => {
    // Registrer emailForm som Alpine data component
    Alpine.data("emailForm", () => ({
      // Initial state
      type: "privat", // Standard valg er privatperson
      error: "", // Fejlbesked (tom ved start)

      // Submit funktionen kaldes når formen sendes
      submit() {
        this.error = ""; // Nulstil fejlbesked

        // Hent og trim værdier fra felterne
        // x-ref giver os adgang via this.$refs
        const email = this.$refs.email.value.trim();
        const phone = this.$refs.phone.value.trim();
        const subject = this.$refs.subject.value;
        const accepted = this.$refs.accept.checked;

        // Validering: Email skal indeholde @
        if (!email || !email.includes("@")) {
          this.error = "Indtast en gyldig email";
          return;
        }

        // Validering: Telefonnummer skal udfyldes
        if (!phone) {
          this.error = "Indtast telefonnummer";
          return;
        }

        // Validering: Støtteform skal vælges
        if (!subject) {
          this.error = "Vælg en støtteform";
          return;
        }

        // Validering: Brugeren skal acceptere
        if (!accepted) {
          this.error = "Du skal acceptere";
          return;
        }

        // Byg URL parametre med basis-info
        const params = new URLSearchParams({
          type: this.type,
          email,
          phone,
          subject,
        });

        // Tilføj besked hvis udfyldt
        const message = this.$refs.message.value.trim();
        if (message) params.append("message", message);

        // Validering og tilføjelse af privatperson-specifikke felter
        if (this.type === "privat") {
          const firstName = this.$refs.firstName.value.trim();
          const lastName = this.$refs.lastName.value.trim();

          if (!firstName || !lastName) {
            this.error = "Udfyld for- og efternavn";
            return;
          }

          params.append("firstName", firstName);
          params.append("lastName", lastName);
        }

        // Validering og tilføjelse af firma-specifikke felter
        if (this.type === "firma") {
          const companyName = this.$refs.companyName.value.trim();
          const cvr = this.$refs.cvr.value.trim();
          const companyAddress = this.$refs.companyAddress.value.trim();

          if (!companyName || !cvr || !companyAddress) {
            this.error = "Udfyld alle firmaoplysninger";
            return;
          }

          params.append("companyName", companyName);
          params.append("cvr", cvr);
          params.append("companyAddress", companyAddress);
        }

        // Redirect til bekræftelsesside med alle data som URL parametre
        window.location.href = `/tilmeldt?${params.toString()}`;
      },
    }));
  });
</script>
