---
// Import af genbrugelige komponenter
import MainLayout from "../layouts/MainLayout.astro";
import Heading from "../components/Heading.astro";
import Text from "../components/Text.astro";
import Button from "../components/Button.astro";
---

<MainLayout title="Kontakt os">
  <!-- Hovedsektion med tilmeldingsformular -->
  <section class="mr-section_right ml-section_left pb-20 pt-10">
    <div class="max-w-3xl mx-auto">
      <Heading
        htmlheading="h1"
        size="medium"
        weight="bold"
        font="display"
        stylingclasses="mb-3 text-center"
      >
        TILMELDING
      </Heading>

      <Text size="medium" stylingclasses="mb-6 text-center max-w-xl mx-auto">
        Tak fordi du vil støtte os. Inden vi kan tage i mod din hjælp skal du
        oplyse din email og hvilken form for støtte du vil give. Vi kontakter
        dig efterfølgende og bekræfter din tilmelding.
      </Text>

      <!-- Formular container med skygge og afrunding -->
      <div
        class="max-w-2xl mx-auto p-6 md:p-8 bg-white shadow-2xl rounded-lg border border-orange--400"
      >
        <!-- Alpine.js formular - x-data kobler til emailForm funktionen -->
        <!-- @submit.prevent forhindrer standard formular submit og kalder vores submit() funktion -->
        <form x-data="emailForm" @submit.prevent="submit" class="space-y-5">
          <!-- Dropdown: Vælg privatperson eller virksomhed -->
          <!-- x-model="type" binder værdien til Alpine's type variabel -->
          <div>
            <label
              class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
            >
              Er du privatperson eller virksomhed? *
            </label>
            <select
              x-model="type"
              class="form-select w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all shadow-sm appearance-none cursor-pointer"
            >
              <option value="privat">Privatperson</option>
              <option value="firma">Firma</option>
            </select>
          </div>

          <!-- Privatperson felter - kun vist når type === 'privat' -->
          <!-- x-show styrer synlighed, x-transition tilføjer smooth animation -->
          <div x-show="type === 'privat'" x-transition class="space-y-5">
            <!-- Fornavn og Efternavn side by side på desktop -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-5">
              <div>
                <label
                  class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
                  >Fornavn *</label
                >
                <input
                  x-ref="firstName"
                  type="text"
                  class="form-input w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all shadow-sm"
                  placeholder="Dit fornavn"
                />
              </div>

              <div>
                <label
                  class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
                  >Efternavn *</label
                >
                <input
                  x-ref="lastName"
                  type="text"
                  class="form-input w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all shadow-sm"
                  placeholder="Dit efternavn"
                />
              </div>
            </div>
          </div>

          <!-- Firma felter - kun vist når type === 'firma' -->
          <div x-show="type === 'firma'" x-transition class="space-y-5">
            <!-- Firmanavn -->
            <div>
              <label
                class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
                >Firmanavn *</label
              >
              <input
                x-ref="companyName"
                type="text"
                class="form-input w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all shadow-sm"
                placeholder="Dit firmanavn"
              />
            </div>

            <!-- CVR og Adresse side by side på desktop -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-5">
              <div>
                <label
                  class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
                  >CVR-nummer *</label
                >
                <input
                  x-ref="cvr"
                  type="text"
                  class="form-input w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all shadow-sm"
                  placeholder="12345678"
                />
              </div>

              <div>
                <label
                  class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
                  >Adresse *</label
                >
                <input
                  x-ref="companyAddress"
                  type="text"
                  class="form-input w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all shadow-sm"
                  placeholder="Din virksomhedsadresse"
                />
              </div>
            </div>
          </div>

          <!-- Email felt - obligatorisk -->
          <div>
            <label
              class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
              >E-mail *</label
            >
            <input
              x-ref="email"
              type="email"
              class="form-input w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all shadow-sm"
              placeholder="eksempel@email.com"
              required
            />
          </div>

          <!-- Telefonnummer og Støtteform side by side på desktop -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-5">
            <!-- Telefonnummer felt med auto-sanitering -->
            <!-- @input fjerner ugyldige tegn mens brugeren skriver -->
            <div>
              <label
                class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
                >Telefonnummer *</label
              >
              <input
                x-ref="phone"
                type="tel"
                placeholder="+45 00 00 00 00"
                class="form-input w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all shadow-sm"
                @input="$el.value = $el.value.replace(/[^0-9+ ]/g,'')"
                required
              />
            </div>

            <!-- Støtteform dropdown - obligatorisk -->
            <div>
              <label
                class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
                >Støtteform *</label
              >
              <select
                x-ref="subject"
                class="form-select w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all shadow-sm appearance-none cursor-pointer"
                required
              >
                <option value="" disabled selected>Vælg en mulighed</option>
                <option value="Frivillig">Frivillig</option>
                <option value="Støttemedlem">Støttemedlem</option>
                <option value="Samarbejdspartner">Samarbejdspartner</option>
                <option value="Erhvervspartner">Erhvervspartner</option>
                <option value="Budskabet">Budskabet</option>
                <option value="andet">Andet</option>
              </select>
            </div>
          </div>

          <!-- Besked felt - valgfrit -->
          <div>
            <label
              class="block mb-2 font-semibold text-black font-sans text-sm md:text-base"
              >Besked (valgfrit)</label
            >
            <textarea
              x-ref="message"
              rows="5"
              class="form-textarea w-full rounded-lg border-2 border-orange--100 bg-yellow--100 py-3 px-4 font-sans text-sm md:text-base focus:border-orange--400 focus:ring-2 focus:ring-orange--200 hover:border-orange--200 transition-all resize-none shadow-sm"
              placeholder="Skriv din besked her…"></textarea>
          </div>

          <!-- Accept checkbox - obligatorisk -->
          <div class="flex items-start gap-3 pt-1">
            <input
              id="accept"
              x-ref="accept"
              type="checkbox"
              class="form-checkbox mt-1 rounded border-2 border-orange--100 text-orange--400 focus:ring-orange--200 w-5 h-5 cursor-pointer"
              required
            />
            <label
              for="accept"
              class="text-sm md:text-base leading-relaxed font-sans cursor-pointer"
            >
              Jeg accepterer vilkårene og giver tilladelse til at blive
              kontaktet *
            </label>
          </div>

          <!-- Fejlbesked - kun vist når der er en fejl -->
          <!-- x-show="error" viser kun hvis error ikke er tom -->
          <!-- x-text="error" indsætter fejlteksten -->
          <div
            x-show="error"
            x-transition
            class="p-3 bg-orange--100 border-l-4 border-orange--400 rounded-lg shadow-sm"
          >
            <p
              x-text="error"
              class="text-orange--400 font-semibold font-sans text-sm"
            >
            </p>
          </div>

          <!-- Submit knap -->
          <div class="pt-4">
            <Button type="submit" variant="black" size="medium">
              Send besked
            </Button>
          </div>
        </form>
      </div>
    </div>
  </section>
</MainLayout>

<script is:inline>
  // Vent på Alpine er klar
  document.addEventListener("alpine:init", () => {
    // Registrer emailForm som Alpine data component
    Alpine.data("emailForm", () => ({
      // Initial state
      type: "privat", // Standard valg er privatperson
      error: "", // Fejlbesked (tom ved start)

      // Submit funktionen kaldes når formen sendes
      submit() {
        this.error = ""; // Nulstil fejlbesked

        // Hent og trim værdier fra felterne
        // x-ref giver os adgang via this.$refs
        const email = this.$refs.email.value.trim();
        const phone = this.$refs.phone.value.trim();
        const subject = this.$refs.subject.value;
        const accepted = this.$refs.accept.checked;

        // Validering: Email skal indeholde @
        if (!email || !email.includes("@")) {
          this.error = "Indtast en gyldig email";
          return;
        }

        // Validering: Telefonnummer skal udfyldes
        if (!phone) {
          this.error = "Indtast telefonnummer";
          return;
        }

        // Validering: Støtteform skal vælges
        if (!subject) {
          this.error = "Vælg en støtteform";
          return;
        }

        // Validering: Brugeren skal acceptere
        if (!accepted) {
          this.error = "Du skal acceptere";
          return;
        }

        // Byg URL parametre med basis-info
        const params = new URLSearchParams({
          type: this.type,
          email,
          phone,
          subject,
        });

        // Tilføj besked hvis udfyldt
        const message = this.$refs.message.value.trim();
        if (message) params.append("message", message);

        // Validering og tilføjelse af privatperson-specifikke felter
        if (this.type === "privat") {
          const firstName = this.$refs.firstName.value.trim();
          const lastName = this.$refs.lastName.value.trim();

          if (!firstName || !lastName) {
            this.error = "Udfyld for- og efternavn";
            return;
          }

          params.append("firstName", firstName);
          params.append("lastName", lastName);
        }

        // Validering og tilføjelse af firma-specifikke felter
        if (this.type === "firma") {
          const companyName = this.$refs.companyName.value.trim();
          const cvr = this.$refs.cvr.value.trim();
          const companyAddress = this.$refs.companyAddress.value.trim();

          if (!companyName || !cvr || !companyAddress) {
            this.error = "Udfyld alle firmaoplysninger";
            return;
          }

          params.append("companyName", companyName);
          params.append("cvr", cvr);
          params.append("companyAddress", companyAddress);
        }

        // Redirect til bekræftelsesside med alle data som URL parametre
        window.location.href = `/tilmeldt?${params.toString()}`;
      },
    }));
  });
</script>
